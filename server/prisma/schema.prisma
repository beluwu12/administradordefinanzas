generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(uuid())
  email             String             @unique
  password          String
  firstName         String
  lastName          String
  verified          Boolean            @default(false)
  createdAt         DateTime           @default(now())
  defaultCurrency   String             @default("USD")
  timezone          String             @default("America/Caracas")
  country           Country            @default(VE)
  billReminderDays  Int                @default(3)
  billReminders     Boolean            @default(true)
  budgetAlerts      Boolean            @default(true)
  budgetThreshold   Int                @default(80)
  language          String             @default("es")
  notifyEmail       Boolean            @default(false)
  notifyGoals       Boolean            @default(true)
  notifyPush        Boolean            @default(true)
  notifySound       Boolean            @default(true)
  notifyWeekly      Boolean            @default(false)
  soundVolume       Int                @default(70)
  theme             String             @default("system")
  dualCurrencyEnabled Boolean          @default(true)
  budgets           Budget[]
  fixedExpenses     FixedExpense[]
  goals             Goal[]
  notifications     Notification[]
  pushSubscriptions PushSubscription[]
  sessions          Session[]
  tags              Tag[]
  transactions      Transaction[]
}

model Session {
  id         String    @id @default(uuid())
  tokenHash  String    @unique
  userId     String
  userAgent  String?
  ipAddress  String?
  createdAt  DateTime  @default(now())
  expiresAt  DateTime
  lastUsedAt DateTime  @default(now())
  revokedAt  DateTime?
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, revokedAt])
  @@index([tokenHash])
}

model Tag {
  id           String        @id @default(uuid())
  name         String
  color        String?
  userId       String
  createdAt    DateTime      @default(now())
  budgets      Budget[]
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[] @relation("TagToTransaction")

  @@unique([name, userId])
}

model Transaction {
  id             String        @id @default(uuid())
  amount         Float
  currency       String        @default("USD")
  exchangeRate   Float?
  type           String
  description    String
  source         String?
  date           DateTime      @default(now())
  userId         String
  createdAt      DateTime      @default(now())
  deletedAt      DateTime?
  fixedExpenseId String?
  fixedExpense   FixedExpense? @relation(fields: [fixedExpenseId], references: [id])
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags           Tag[]         @relation("TagToTransaction")

  @@index([userId, date])
  @@index([userId, type])
  @@index([userId, deletedAt])
}

model FixedExpense {
  id             String        @id @default(uuid())
  amount         Float
  currency       String        @default("USD")
  description    String
  dueDay         Int
  isActive       Boolean       @default(true)
  userId         String
  createdAt      DateTime      @default(now())
  deletedAt      DateTime?
  lastNotified5d DateTime?
  lastNotified3d DateTime?
  lastNotified1d DateTime?
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions   Transaction[]

  @@index([userId, dueDay])
  @@index([userId, deletedAt])
}

model Goal {
  id             String             @id @default(uuid())
  title          String
  description    String?
  totalCost      Float
  currency       String             @default("USD")
  durationMonths Int
  monthlyAmount  Float
  deadline       DateTime?
  startDate      DateTime           @default(now())
  savedAmount    Float              @default(0)
  tag            String?
  userId         String
  createdAt      DateTime           @default(now())
  deletedAt      DateTime?
  color          String?
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  contributions  GoalContribution[]
  progress       GoalMonth[]

  @@index([userId, deletedAt])
}

model GoalMonth {
  id         String  @id @default(uuid())
  goalId     String
  monthIndex Int
  target     Float
  isQ1Paid   Boolean @default(false)
  isQ2Paid   Boolean @default(false)
  goal       Goal    @relation(fields: [goalId], references: [id], onDelete: Cascade)
}

model GoalContribution {
  id     String   @id @default(uuid())
  amount Float
  note   String?
  date   DateTime @default(now())
  goalId String
  goal   Goal     @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId, date])
}

model Budget {
  id              String   @id @default(uuid())
  limit           Float
  rolloverEnabled Boolean  @default(false)
  rolloverAmount  Float    @default(0)
  month           Int
  year            Int
  tagId           String
  userId          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  tag             Tag      @relation(fields: [tagId], references: [id])
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tagId, month, year, userId])
  @@index([userId, month, year])
}

model ExchangeRate {
  id        String   @id @default(uuid())
  source    String
  pair      String
  rate      Float
  fetchedAt DateTime @default(now())

  @@index([fetchedAt])
  @@index([pair, fetchedAt])
}

model Notification {
  id        String   @id @default(uuid())
  title     String
  body      String
  type      String
  isRead    Boolean  @default(false)
  link      String?
  userId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
}

model PushSubscription {
  id        String   @id @default(uuid())
  endpoint  String
  p256dh    String
  auth      String
  userId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([endpoint, userId])
}

enum Country {
  VE
  EC
  CO
  CL
  MX
  AR
  US
}
