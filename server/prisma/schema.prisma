// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  firstName String
  lastName  String
  pin       String   // Hashed 4-digit PIN
  createdAt DateTime @default(now())

  transactions  Transaction[]
  fixedExpenses FixedExpense[]
  tags          Tag[]
  goals         Goal[]
}

model Tag {
  id           String        @id @default(uuid())
  name         String
  color        String?
  transactions Transaction[]
  
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  
  createdAt    DateTime      @default(now())

  @@unique([name, userId]) // Tags are unique per user
}

model Transaction {
  id           String   @id @default(uuid())
  amount       Float
  currency     String   @default("USD") // 'USD' or 'VES'
  exchangeRate Float?   // Value of 1 USD in VES
  type         String   // 'INCOME' or 'EXPENSE'
  description  String
  source       String?
  date         DateTime @default(now())
  
  tags         Tag[]
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String

  createdAt    DateTime @default(now())

  @@index([userId, date]) // Optimize dashboard queries
  @@index([userId, type]) // Optimize balance calculation
}

model FixedExpense {
  id          String   @id @default(uuid())
  amount      Float
  currency    String   @default("USD")
  description String
  dueDay      Int      // 1-31
  isActive    Boolean  @default(true)
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String

  createdAt   DateTime @default(now())
}

model Goal {
  id             String      @id @default(uuid())
  title          String
  description    String?
  totalCost      Float
  currency       String      @default("USD")
  
  // Logic & Calculations
  durationMonths Int
  monthlyAmount  Float
  deadline       DateTime?   // Calculated
  
  // Progress Tracking
  startDate      DateTime    @default(now())
  savedAmount    Float       @default(0)
  tag            String?     // Optional tag to link Income transactions automatically
  
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String

  progress       GoalMonth[]
  
  createdAt      DateTime    @default(now())
}

model GoalMonth {
  id          String  @id @default(uuid())
  goal        Goal    @relation(fields: [goalId], references: [id], onDelete: Cascade)
  goalId      String
  
  monthIndex  Int     // 1 to 12
  target      Float
  isCompleted Boolean @default(false)
}

model ExchangeRate {
  id        String   @id @default(uuid())
  source    String   // e.g. "BCV"
  pair      String   // e.g. "USD-VES"
  rate      Float
  fetchedAt DateTime @default(now())

  @@index([fetchedAt]) // Optimize finding latest rate
}
